(this.webpackJsonpperseus=this.webpackJsonpperseus||[]).push([[0],{107:function(e,t,a){},108:function(e,t,a){"use strict";a.r(t);var n=a(0),r=a.n(n),i=a(9),o=a.n(i),c=(a(56),a(8)),s=a(45),u=a(15),l=a(114),m=a(1),d=a(111),p=a(112),f=a(113),y=a(12),g=a(10),v=a.n(g),b=a(28),E=a.n(b),h=(a(58),function(e,t){var a=t;if(e.current.getLayer(t)||e.current.getLayer("".concat(t,"1"))){a=e.current.getLayer(t)?"".concat(t,"1"):t;var n=e.current.getLayer(t)?t:"".concat(t,"1");e.current.removeLayer(n),e.current.removeSource(n)}return a}),O=function(e,t,a){t.current.getCanvas().style.cursor="pointer";for(var n=e.features[0].geometry.coordinates.slice(),r=e.features[0].properties.description;Math.abs(e.lngLat.lng-n[0])>180;)n[0]+=e.lngLat.lng>n[0]?360:-360;a.current.setLngLat(n).setHTML(r).addTo(t.current)},S=function(e,t){e.current.getCanvas().style.cursor="",t.current.remove()},N={plotLine:function(e,t,a,n,r){var i=h(e,"route");e.current.addLayer({id:i,type:"line",source:{type:"geojson",data:{type:"Feature",properties:{},geometry:a}},layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#6f4cff","line-width":8}}).fitBounds(function(e){var t=new v.a.LngLat(e[0][0],e[0][1]),a=new v.a.LngLatBounds(t,t);return e.reduce((function(e,t){var a=Object(c.a)(t,2),n=a[0],r=a[1];return e.extend(new v.a.LngLat(n,r))}),a)}(a.coordinates),Object(y.a)({},r,{padding:{top:40,bottom:40,left:20,right:20}})),i=h(e,"locationMarkers"),e.current.addLayer({id:i,type:"symbol",source:{type:"geojson",data:{type:"FeatureCollection",features:a.coordinates.map((function(e){var t=Object(c.a)(e,4),a=t[0],r=t[1],i=t[2],o=t[3];return{type:"Feature",properties:{description:E.a.renderToString(n({type:"locationMarker",coordinates:[r,a],alt:i,recorded_at:o})),icon:"marker"},geometry:new _.Point({type:"Point",coordinates:[a,r]})}}))}},layout:{"icon-image":"{icon}-15","icon-allow-overlap":!1}}),e.current.on("mouseenter",i,(function(a){return O(a,e,t)})),e.current.on("mouseleave",i,(function(){return S(e,t)}))},useMarkers:function(e,t,a,n,r,i){a.current&&a.current.length&&a.current.forEach((function(e){return e.remove()}));var o=[],c=h(e,"deviceStatusMarkers");n.forEach((function(a){var n=a.start,i=a.end,c=a.deviceStatus,s=a.activity;if(n||i){var u=F.getIcon(s||c),l=document.createElement("div");l.className="marker-container",l.innerHTML="<img src=".concat(F.getImageSource(u)," alt=").concat(u,' class="marker-image"/>'),l.addEventListener("mouseenter",(function(n){return function(e,t,a,n,r){var i=n.start,o=n.end;t.current.getCanvas().style.cursor="pointer";var c=(i&&i.location?i.location.coordinates:o&&o.location?o.location.coordinates:[]).slice(),s=E.a.renderToString(r(Object(y.a)({type:"deviceStatusMarker"},n)));a.current.setLngLat(c).setHTML(s).addTo(t.current)}(0,e,t,a,r)})),l.addEventListener("mouseleave",(function(){return S(e,t)}));var m=n&&n.location?n.location.coordinates:i&&i.location?i.location.coordinates:[];o.push(new v.a.Marker(l).setLngLat(m).addTo(e.current))}})),e.current.on("mouseenter",c,(function(a){return O(a,e,t)})),e.current.on("mouseleave",c,(function(){return S(e,t)})),a.current=o}},k=a(29),_={Line:function e(t){var a=t.type,n=t.coordinates;Object(k.a)(this,e),this.type=a,this.coordinates=n},Point:function e(t){var a=t.type,n=t.coordinates;Object(k.a)(this,e),this.type=a,this.coordinates=n}},L=a(22),w={useMap:function(e,t){var a=t.accessToken,n=Object(L.a)(t,["accessToken"]),i=r.a.useRef();return r.a.useEffect((function(){i&&i.current||!a||(i.current=new v.a.Map(Object(y.a)({container:e,style:"mapbox://styles/mapbox/streets-v9",keyboard:!0,center:[0,0],accessToken:a},n)))}),[e,a]),r.a.useEffect((function(){a&&(v.a.accessToken=a)}),[a]),i},usePopup:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=r.a.useRef(new v.a.Popup(Object(y.a)({closeButton:!1,closeOnClick:!1},t)));return r.a.useEffect((function(){e.current&&e.current.on("load",(function(){a.current.addTo(e.current)}))}),[e,a]),a},useAccessToken:function(e,t){var a=r.a.useState(e),n=Object(c.a)(a,2),i=n[0],o=n[1];return r.a.useEffect((function(){if(e)localStorage.setItem("accessToken",e);else{var t=localStorage.getItem("accessToken");t&&(v.a.accessToken=t,o(t))}}),[e]),r.a.useEffect((function(){i?t():t("Missing access token")}),[i]),i}},T=a(21),j=a(44),M=a(59),I=a(60),J=new(a(61))({allErrors:!0}),x=J.compile(M),P=J.compile(I),C=function(e){var t=e.recorded_at,a=e.location,n={};return t&&(n.timestamp=t),a&&a.geometry&&(n.location=new _.Point(a.geometry)),n},A={geofence:function(e){var t=e.arrival,a=e.geofence,n=new _.Point(t.location.geometry),r=new _.Point(a.geometry);return{arrival:{arrivalPoint:n,arrivalTime:t.location.recorded_at},geofence:{geofencePoint:r,geofenceId:a.geofence_id,geofenceMetadata:JSON.stringify(a.metadata,null,2),radius:Number(a.radius)}}},device_status:function(e){var t=e.activity,a=e.duration,n=e.value,r=C(e.end),i=C(e.start),o={};return t&&(o.activity=t),a&&(o.duration=a),Object(y.a)({start:i,end:r,deviceStatus:n},o)}},B=function(e){var t=e.type,a=e.data;return A[t]?A[t](a):a},D=["disconnected","inactive","unknown","stop","walk","run","drive"],R={trip:x,LineString:P},F={parseMarker:B,getIcon:function(e,t){return D.includes(t)?t:D.includes(e)?e:"unknown"},secondsToHms:function(e){e=Number(e);var t=Math.floor(e/3600),a=Math.floor(e%3600/60),n=Math.floor(e%3600%60);return(t>0?t+" h ":"")+(a>0?a+" m ":"")+(n>0?n+" s":"")},markersByType:function(e){return function(t){var a=e.reduce((function(e,t){return Object(y.a)({},e,Object(T.a)({},t.type,e[t.type]?[B(t)].concat(Object(j.a)(e[t.type])):[B(t)]))}),{});return t&&a[t]?a[t]:a}},validateInputJSON:function(e){var t=R[e.type||"trip"];return!(!t||t(e))&&t.errors},valid_device_status_states:D,getImageSource:function(e){return"".concat("/perseus","/assets/").concat(e,".png")}},z=(a(38),function(e){var t=e.trip,a=e.showTripModal,n=e.updateJson,i=e.hideModal,o=e.showModal,y=e.fetchError,g=r.a.useState(JSON.stringify(t,null,"\t")),v=Object(c.a)(g,2),b=v[0],E=v[1],h=r.a.useState(void 0),O=Object(c.a)(h,2),S=O[0],N=O[1],k=r.a.useState(void 0),_=Object(c.a)(k,2),L=_[0],w=_[1],T=y||L;r.a.useEffect((function(){JSON.stringify(t)!==JSON.stringify(b)&&E(JSON.stringify(t,null,"\t"))}),[t]),r.a.useEffect((function(){y&&y!==T&&w(y)}),[y]);var j=function(e){var t=F.validateInputJSON(e);return t&&t.length?w(t):w(null),Boolean(t)};return r.a.createElement(r.a.Fragment,null,r.a.createElement(s.a,{intent:u.a.SUCCESS,className:"show-trip-button",onClick:function(){return a?i():o()}},"Update JSON"),r.a.createElement(l.a,{isOpen:T||a,title:"Add your own JSON",onClose:i,className:"dialog"},r.a.createElement("div",{className:m.a.DIALOG_BODY},r.a.createElement("div",{className:"dialog-container"},r.a.createElement(d.a,{value:b,disabled:!1,onChange:function(e){return E(e.target.value)},className:"user-summary-input",placeholder:"Paste trip_summary here",onBlur:function(e){e&&e.preventDefault();var t=e.target.value;if(t)try{var a=JSON.parse(t);j(a)}catch(n){console.error(n),w(n)}}}),T?r.a.createElement("div",{className:"error-table-container"},Array.isArray(T)?r.a.createElement(p.a,{className:"error-table",bordered:!0},r.a.createElement("caption",null,"There ",T.length>1?"are":"is an"," ",T.length>1?T.length:""," issue",T.length>1?"s":""),r.a.createElement("thead",null,r.a.createElement("tr",null,r.a.createElement("th",null,"Location"),r.a.createElement("th",null,"Issue"))),r.a.createElement("tbody",null,T.map((function(e){return r.a.createElement("tr",{key:e.dataPath},r.a.createElement("td",null,r.a.createElement("div",{className:"table-content"},e.dataPath)),r.a.createElement("td",null,r.a.createElement("div",{className:"table-content"},e.message)))})))):r.a.createElement("div",{className:"error-table error"},T.message?T.message:JSON.stringify(T))):null)),r.a.createElement("div",{className:m.a.DIALOG_FOOTER},r.a.createElement("div",{className:m.a.DIALOG_FOOTER_ACTIONS},r.a.createElement(f.a,{text:S,buttonText:"Browse",className:"file-input",onInputChange:function(e){e&&e.preventDefault();var t=new FileReader,a=e.target.files[0];N(a&&a.name?a.name:void 0),t.readAsText(a,"UTF-8"),t.onload=function(e){var t=e.target.result,a=JSON.parse(t);E(t),j(a)||(n(a),i())}},inputProps:{accept:".json"}}),r.a.createElement(s.a,{disabled:T&&T.length||!b,onClick:function(e){E(JSON.stringify(t,null,"\t")),i()}},"Close"),r.a.createElement(s.a,{intent:u.a.PRIMARY,disabled:T&&T.length||!b,onClick:function(e){try{var t=JSON.parse(b);n(t),i()}catch(a){console.error(a),w(a)}}},"Update")))))}),H=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"],U=function(e){return H[e.getMonth()]+" "+e.getDate()+", "+e.getFullYear()+" "+e.getHours()+":"+e.getMinutes()+":"+e.getSeconds()},G={deviceStatusMarker:function(e){var t=e.start,a=e.end,n=(e.deviceStatus,e.activity),i=e.duration;return r.a.createElement("tbody",null,t?r.a.createElement("tr",{className:"capitalize"},r.a.createElement("td",null,"Start Time"),r.a.createElement("td",null,U(new Date(t.timestamp)))):null,a?r.a.createElement("tr",{className:"capitalize"},r.a.createElement("td",null,"End Time"),r.a.createElement("td",null,U(new Date(a.timestamp)))):null,i?r.a.createElement("tr",null,r.a.createElement("td",null,"Duration"),r.a.createElement("td",null,F.secondsToHms(i))):null,n?r.a.createElement("tr",null,r.a.createElement("td",null,"Activity"),r.a.createElement("td",{className:"capitalize"},n)):null)},locationMarker:function(e){var t=Object(c.a)(e.coordinates,2),a=t[0],n=t[1],i=e.alt,o=e.recorded_at;return r.a.createElement("tbody",null,r.a.createElement("tr",null,r.a.createElement("td",null,"Coordinates"),r.a.createElement("td",{className:"capitalize"},a," ",n)),i?r.a.createElement("tr",null,r.a.createElement("td",null,"Altitude"),r.a.createElement("td",{className:"capitalize"},i)):null,o?r.a.createElement("tr",null,r.a.createElement("td",null,"Recorded at"),r.a.createElement("td",{className:"capitalize"},U(new Date(o)))):null)}},Y={locationMarker:function(){return"location"},deviceStatusMarker:function(e){return e.deviceStatus}},q=function(e){var t=e.type,a=Object(L.a)(e,["type"]);return r.a.createElement("table",{className:"device-status-table"},r.a.createElement("thead",null,r.a.createElement("tr",null,r.a.createElement("th",{colSpan:2,className:"capitalize"},Y[t](a)))),G[t](a))},K=(a(105),a(106),a(107),"map-container"),Q=function(e){return r.a.createElement(q,e)},V=new URLSearchParams(window.location.search),W=V.get("gist"),X=V.get("locations"),Z="true"===V.get("shed_animation"),$=V.get("accessToken"),ee=!V.get("hash")||"false"!==V.get("hash"),te=JSON.parse(X);var ae=function(){var e=r.a.useState(!0),t=Object(c.a)(e,2),a=t[0],n=t[1],i=r.a.useState(void 0),o=Object(c.a)(i,2),s=o[0],u=o[1],l=r.a.useState(void 0),m=Object(c.a)(l,2),d=m[0],p=m[1],f=w.useAccessToken($,p),y={linear:Z},g=w.useMap(K,{accessToken:f,hash:ee,fitBoundsOptions:y}),v=w.usePopup(g),b=w.usePopup(g,{offset:10}),E=r.a.useRef([]);r.a.useEffect((function(){if(f)if(W){var e=W.split("/").pop();fetch("https://api.github.com/gists/".concat(e)).then((function(e){return e.json()})).then((function(e){if(e.message)console.error(e.message),p(e.message);else{var t=JSON.parse(e.files["default.json"]?e.files["default.json"].content:Object.values(e.files)[0].content);u(t)}})).catch((function(e){console.error(e),p(e)}))}else if(te&&te.length){var t=new _.Line({coordinates:te,type:"LineString"});g.current.on("load",(function(){return h(t,!0,!1)}))}else{var a=localStorage.getItem("previousJSON"),n=JSON.parse(a);n&&g.current.on("load",(function(){return h(n,!0)}))}}),[f]);var h=function(e,t,a){if(u(e),t||localStorage.setItem("previousJSON",JSON.stringify(e,null,"\t")),"LineString"===e.type){var r=new _.Line(e);N.plotLine(g,v,r,Q,y),a||n(!1)}else try{var i=e.summary,o=i.locations,c=i.markers,s=new _.Line(o),l=F.markersByType(c)("device_status");N.plotLine(g,v,s,Q,y),N.useMarkers(g,b,E,l,Q)}catch(d){console.error(d),p(d)}};return r.a.createElement("div",{className:"app-container"},f&&r.a.createElement("div",{id:K}),r.a.createElement(z,{fetchError:d,trip:s,showTripModal:a,showModal:function(){return n(!0)},hideModal:function(){return n(!1)},updateJson:h}))};o.a.render(r.a.createElement(ae,null),document.getElementById("root"))},38:function(e,t,a){},51:function(e,t,a){e.exports=a(108)},56:function(e,t,a){},58:function(e,t,a){},59:function(e){e.exports=JSON.parse('{"properties":{"trip_id":{"type":"string","format":"uuid"},"device_id":{"type":"string","format":"uuid"},"started_at":{"type":"string","format":"date-time"},"completed_at":{"type":"string","format":"date-time"},"status":{"type":"string"},"views":{"properties":{"embed_url":{"type":"string","format":"uri"},"share_url":{"type":"string","format":"uri"}}},"analytics":{"properties":{"total_duration":{"type":"number"},"active_count":{"type":"number"},"active_duration":{"type":"number"},"stop_count":{"type":"number"},"stop_duration":{"type":"number"},"active_distance":{"type":"number"},"walk_count":{"type":"number"},"walk_duration":{"type":"number"},"walk_distance":{"type":"number"},"drive_count":{"type":"number"},"drive_duration":{"type":"number"},"drive_distance":{"type":"number"},"inactive_count":{"type":"number"},"inactive_duration":{"type":"number"}}},"summary":{"properties":{"distance":{"type":"number"},"duration":{"type":"number"},"started_at":{"type":"string","format":"date-time"},"completed_at":{"type":"string","format":"date-time"},"device_id":{"type":"string","format":"uuid"},"locations":{"properties":{"type":{"type":"string"},"coordinates":{"type":"array","items":{"type":"array","maxItems":4,"minItems":2,"items":[{"type":"number","minimum":-179.999999,"maximum":179.999999},{"type":"number","minimum":-89.999999,"maximum":89.999999},{"type":["number","null"],"minimum":-12262,"maximum":11000},{"type":"string","format":"date-time"}]}}}},"markers":{"type":"array","items":[{"properties":{"type":{"type":"string"},"data":{"properties":{"activity":{"type":"string"},"duration":{"type":"number"},"value":{"type":"string"},"start":{"properties":{"recorded_at":{"type":"string","format":"date-time"},"location":{"properties":{"recorded_at":{"type":"string","format":"date-time"},"geometry":{"properties":{"type":{"type":"string"},"coordinates":{"type":"array","maxItems":4,"minItems":2,"items":[{"type":"number","minimum":-179.999999,"maximum":179.999999},{"type":"number","minimum":-89.999999,"maximum":89.999999},{"type":["number","null"],"minimum":-12262,"maximum":11000},{"type":"string","format":"date-time"}]}}}}}}},"end":{"properties":{"recorded_at":{"type":"string","format":"date-time"},"location":{"properties":{"recorded_at":{"type":"string","format":"date-time"},"geometry":{"properties":{"type":{"type":"string"},"coordinates":{"type":"array","maxItems":4,"minItems":2,"items":[{"type":"number","minimum":-179.999999,"maximum":179.999999},{"type":"number","minimum":-89.999999,"maximum":89.999999},{"type":["number","null"],"minimum":-12262,"maximum":11000},{"type":"string","format":"date-time"}]}}}}}}}}}}}]}}}}}')},60:function(e){e.exports=JSON.parse('{"properties":{"type":{"type":"string"},"coordinates":{"type":"array","items":{"type":"array","maxItems":4,"minItems":2,"items":[{"type":"number","minimum":-179.999999,"maximum":179.999999},{"type":"number","minimum":-89.999999,"maximum":89.999999},{"type":["number","null"],"minimum":-12262,"maximum":11000},{"type":"string","format":"date-time"}]}}}}')}},[[51,1,2]]]);
//# sourceMappingURL=main.7bbf2c85.chunk.js.map