(this.webpackJsonpperseus=this.webpackJsonpperseus||[]).push([[0],{108:function(e,t,n){},109:function(e,t,n){"use strict";n.r(t);var a=n(0),r=n.n(a),o=n(10),i=n.n(o),c=(n(57),n(8)),s=n(46),u=n(15),l=n(115),m=n(1),d=n(112),p=n(113),f=n(114),y=n(23),g=n(9),v=n(11),b=n.n(v),h=n(29),E=n.n(h);n(59);function O(){var e=Object(y.a)(["deviceStatusMarkers"]);return O=function(){return e},e}function S(){var e=Object(y.a)(["locationMarkers"]);return S=function(){return e},e}function N(){var e=Object(y.a)(["route"]);return N=function(){return e},e}var j,_=function(e,t){var n=t;if(e.current.getLayer(t)||e.current.getLayer("".concat(t,"1"))){n=e.current.getLayer(t)?"".concat(t,"1"):t;var a=e.current.getLayer(t)?t:"".concat(t,"1");e.current.removeLayer(a),e.current.removeSource(a)}return n},k=function(e,t,n){t.current.getCanvas().style.cursor="pointer";for(var a=e.features[0].geometry.coordinates.slice(),r=e.features[0].properties.description;Math.abs(e.lngLat.lng-a[0])>180;)a[0]+=e.lngLat.lng>a[0]?360:-360;n.current.setLngLat(a).setHTML(r).addTo(t.current)},w=function(e,t){e.current.getCanvas().style.cursor="",t.current.remove()},J=function(e){return function(t){return t+e}},T={_zero_:"#6397FF",_one_:"#FF8D69"},L={plotLine:function(e){var t=e.mapRef,n=e.popupRef,a=e.line,r=e.getStatusTable,o=e.fitBoundsOptions,i=e.index,s=_(t,J(i)(N()));t.current.addLayer({id:s,type:"line",source:{type:"geojson",data:{type:"Feature",properties:{},geometry:a}},layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":T[i],"line-width":8}}).fitBounds(function(e){var t=new b.a.LngLat(e[0][0],e[0][1]),n=new b.a.LngLatBounds(t,t);return e.reduce((function(e,t){var n=Object(c.a)(t,2),a=n[0],r=n[1];return e.extend(new b.a.LngLat(a,r))}),n)}(a.coordinates),Object(g.a)({},o,{padding:{top:40,bottom:40,left:20,right:20}})),s=_(t,J(i)(S())),t.current.addLayer({id:s,type:"symbol",source:{type:"geojson",data:{type:"FeatureCollection",features:a.coordinates.map((function(e){var t=Object(c.a)(e,4),n=t[0],a=t[1],o=t[2],i=t[3];return{type:"Feature",properties:{description:E.a.renderToString(r({type:"locationMarker",coordinates:[a,n],alt:o,recorded_at:i})),icon:"marker"},geometry:new x.Point({type:"Point",coordinates:[n,a]})}}))}},layout:{"icon-image":"{icon}-15","icon-allow-overlap":!1}}),t.current.on("mouseenter",s,(function(e){return k(e,t,n)})),t.current.on("mouseleave",s,(function(){return w(t,n)}))},useMarkers:function(e){var t=e.mapRef,n=e.popupRef,a=e.markersRef,r=e.deviceStatusMarkers,o=e.getStatusTable,i=(e.fitBoundsOptions,e.index),c=_(t,J(i)(O())),s=r.map((function(e){var a=e.start,r=e.end,i=e.deviceStatus,c=e.activity;if(a||r){var s=X.getIcon(c||i),u=document.createElement("div");u.className="marker-container",u.innerHTML="<img src=".concat(X.getImageSource(s)," alt=").concat(s,' class="marker-image"/>'),u.addEventListener("mouseenter",(function(a){return function(e,t,n,a,r){var o=a.start,i=a.end;t.current.getCanvas().style.cursor="pointer";var c=(o&&o.location?o.location.coordinates:i&&i.location?i.location.coordinates:[]).slice(),s=E.a.renderToString(r(Object(g.a)({type:"deviceStatusMarker"},a)));n.current.setLngLat(c).setHTML(s).addTo(t.current)}(0,t,n,e,o)})),u.addEventListener("mouseleave",(function(){return w(t,n)}));var l=a&&a.location?a.location.coordinates:r&&r.location?r.location.coordinates:[];return new b.a.Marker(u).setLngLat(l).addTo(t.current)}return null})).filter(Boolean);t.current.on("mouseenter",c,(function(e){return k(e,t,n)})),t.current.on("mouseleave",c,(function(){return w(t,n)})),a.current=s}},M=n(30),x={Line:function e(t){var n=t.type,a=t.coordinates;Object(M.a)(this,e),this.type=n,this.coordinates=a},Point:function e(t){var n=t.type,a=t.coordinates;Object(M.a)(this,e),this.type=n,this.coordinates=a}},I=n(19),C={useMap:function(e,t){var n=t.accessToken,a=Object(I.a)(t,["accessToken"]),o=r.a.useRef();return r.a.useEffect((function(){o&&o.current||!n||(o.current=new b.a.Map(Object(g.a)({container:e,style:"mapbox://styles/mapbox/streets-v9",keyboard:!0,center:[0,0],accessToken:n},a)))}),[e,n]),r.a.useEffect((function(){n&&(b.a.accessToken=n)}),[n]),o},usePopup:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=r.a.useRef(new b.a.Popup(Object(g.a)({closeButton:!1,closeOnClick:!1},t)));return r.a.useEffect((function(){e.current&&e.current.on("load",(function(){n.current.addTo(e.current)}))}),[e,n]),n},useAccessToken:function(e,t){var n=r.a.useState(e),a=Object(c.a)(n,2),o=a[0],i=a[1];return r.a.useEffect((function(){if(e)localStorage.setItem("accessToken",e);else{var t=localStorage.getItem("accessToken");t&&(b.a.accessToken=t,i(t))}}),[e]),r.a.useEffect((function(){o?t():t("Missing access token")}),[o]),o}},P=n(17),R=n(45),A=n(60),B=n(61),D=new(n(62))({allErrors:!0}),F=D.compile(A),z=D.compile(B),U=function(e){var t=e.recorded_at,n=e.location,a={};return t&&(a.timestamp=t),n&&n.geometry&&(a.location=new x.Point(n.geometry)),a},H={geofence:function(e){var t=e.arrival,n=e.geofence,a=new x.Point(t.location.geometry),r=new x.Point(n.geometry);return{arrival:{arrivalPoint:a,arrivalTime:t.location.recorded_at},geofence:{geofencePoint:r,geofenceId:n.geofence_id,geofenceMetadata:JSON.stringify(n.metadata,null,2),radius:Number(n.radius)}}},device_status:function(e){var t=e.activity,n=e.duration,a=e.value,r=U(e.end),o=U(e.start),i={};return t&&(i.activity=t),n&&(i.duration=n),Object(g.a)({start:o,end:r,deviceStatus:a},i)}},G=function(e){var t=e.type,n=e.data;return H[t]?H[t](n):n},Y=["disconnected","inactive","unknown","stop","walk","run","drive"],Z={trip:F,LineString:z},K={updateJson:"UPDATE_JSON",addNewJson:"ADD_NEW_JSON",changeJsonIndex:"UPDATE_JSON_INDEX"},W=(j={},Object(P.a)(j,K.updateJson,(function(e,t){var n=Object(g.a)({},e),a=t.index,r=t.json;return n.jsons[a]=r,n})),Object(P.a)(j,K.addNewJson,(function(e,t){var n=Object(g.a)({},e),a=t.json,r=t.noPageChange;n.jsons[e.currentJson]=a;var o=r?e.currentJson:1;return n.currentJson=o,n})),Object(P.a)(j,K.changeJsonIndex,(function(e,t){var n=t.index,a=Object(g.a)({},e);return a.currentJson=n,a})),j),X={parseMarker:G,getIcon:function(e,t){return Y.includes(t)?t:Y.includes(e)?e:"unknown"},secondsToHms:function(e){e=Number(e);var t=Math.floor(e/3600),n=Math.floor(e%3600/60),a=Math.floor(e%3600%60);return(t>0?t+" h ":"")+(n>0?n+" m ":"")+(a>0?a+" s":"")},markersByType:function(e){return function(t){var n=e.reduce((function(e,t){return Object(g.a)({},e,Object(P.a)({},t.type,e[t.type]?[G(t)].concat(Object(R.a)(e[t.type])):[G(t)]))}),{});return t&&n[t]?n[t]:n}},validateInputJSON:function(e){var t=Z[e.type||"trip"];return!(!t||t(e))&&t.errors},valid_device_status_states:Y,getImageSource:function(e){return"".concat("/perseus","/assets/").concat(e,".png")},baseReducer:function(e,t){var n=t.type,a=Object(I.a)(t,["type"]);return W[n]?W[n](e,a):e},reducerActions:K},q=(n(39),function(e){var t=e.trip,n=e.showTripModal,a=e.updateJson,o=e.hideModal,i=e.showModal,y=e.fetchError,g=e.currentJsonIndex,v=e.goToPageZero,b=r.a.useState(JSON.stringify(t,null,"\t")),h=Object(c.a)(b,2),E=h[0],O=h[1],S=r.a.useState(void 0),N=Object(c.a)(S,2),j=N[0],_=N[1],k=r.a.useState(void 0),w=Object(c.a)(k,2),J=w[0],T=w[1],L=y||J;r.a.useEffect((function(){JSON.stringify(t)!==JSON.stringify(E)&&O(JSON.stringify(t,null,"\t"))}),[t]),r.a.useEffect((function(){y&&y!==L&&T(y)}),[y]);var M,x=function(e){var t=X.validateInputJSON(e);return t&&t.length?T(t):T(null),Boolean(t)},I=function(e){try{var t=JSON.parse(E);a(e?{json:t,showModal:!g}:{json:t,showModal:!0,noPageChange:!0})}catch(n){console.error(n),T(n)}};return r.a.createElement(r.a.Fragment,null,r.a.createElement(s.a,{intent:u.a.SUCCESS,className:"show-trip-button",onClick:function(){return n?o():i()}},"Update JSON"),r.a.createElement(l.a,{isOpen:L||n,title:(M=Boolean(t),M?"Modify data":"Add your own JSON"),onClose:o,className:"dialog",isCloseButtonShown:!1,canEscapeKeyClose:!1,canOutsideClickClose:!1},r.a.createElement("div",{className:m.a.DIALOG_BODY},r.a.createElement("div",{className:"dialog-container"},r.a.createElement(d.a,{value:E||"",disabled:!1,onChange:function(e){return O(e.target.value)},className:"user-summary-input",placeholder:"Paste trip_summary here",onBlur:function(e){e&&e.preventDefault();var t=e.target.value;if(t)try{var n=JSON.parse(t);x(n)}catch(a){console.error(a),T(a)}}}),L?r.a.createElement("div",{className:"error-table-container"},Array.isArray(L)?r.a.createElement(p.a,{className:"error-table",bordered:!0},r.a.createElement("caption",null,"There ",L.length>1?"are":"is an"," ",L.length>1?L.length:""," issue",L.length>1?"s":""),r.a.createElement("thead",null,r.a.createElement("tr",null,r.a.createElement("th",null,"Location"),r.a.createElement("th",null,"Issue"))),r.a.createElement("tbody",null,L.map((function(e){return r.a.createElement("tr",{key:e.dataPath},r.a.createElement("td",null,r.a.createElement("div",{className:"table-content"},e.dataPath)),r.a.createElement("td",null,r.a.createElement("div",{className:"table-content"},e.message)))})))):r.a.createElement("div",{className:"error-table error"},L.message?L.message:JSON.stringify(L))):null)),r.a.createElement("div",{className:m.a.DIALOG_FOOTER},r.a.createElement("div",{className:m.a.DIALOG_FOOTER_ACTIONS},r.a.createElement(f.a,{text:j,buttonText:"Browse",className:"file-input",onInputChange:function(e){e&&e.preventDefault();var t=new FileReader,n=e.target.files[0];_(n&&n.name?n.name:void 0),t.readAsText(n,"UTF-8"),t.onload=function(e){var t=e.target.result,n=JSON.parse(t);O(t),x(n)||(a({json:n,showModal:!0,noPageChange:!0}),o())}},inputProps:{accept:".json"}}),g?r.a.createElement(s.a,{icon:"caret-left",className:"add-new-json",disabled:L&&L.length,onClick:function(e){e&&e.preventDefault();try{var t=JSON.parse(E);t&&a(t,!1,!0),v()}catch(n){console.error(n),T(n)}}},"Check previous JSON"):r.a.createElement(s.a,{icon:"plus",className:"add-new-json",disabled:L&&L.length||!E,onClick:function(){return I(!0)}},"Add another JSON"),r.a.createElement(s.a,{disabled:L&&L.length||!E,onClick:function(e){O(JSON.stringify(t,null,"\t")),o()}},"Close"),r.a.createElement(s.a,{intent:u.a.PRIMARY,disabled:L&&L.length||!E,onClick:function(){return I()}},"Update")))))}),Q=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"],V=function(e){return Q[e.getMonth()]+" "+e.getDate()+", "+e.getFullYear()+" "+e.getHours()+":"+e.getMinutes()+":"+e.getSeconds()},$={deviceStatusMarker:function(e){var t=e.start,n=e.end,a=(e.deviceStatus,e.activity),o=e.duration;return r.a.createElement("tbody",null,t?r.a.createElement("tr",{className:"capitalize"},r.a.createElement("td",null,"Start Time"),r.a.createElement("td",null,V(new Date(t.timestamp)))):null,n?r.a.createElement("tr",{className:"capitalize"},r.a.createElement("td",null,"End Time"),r.a.createElement("td",null,V(new Date(n.timestamp)))):null,o?r.a.createElement("tr",null,r.a.createElement("td",null,"Duration"),r.a.createElement("td",null,X.secondsToHms(o))):null,a?r.a.createElement("tr",null,r.a.createElement("td",null,"Activity"),r.a.createElement("td",{className:"capitalize"},a)):null)},locationMarker:function(e){var t=Object(c.a)(e.coordinates,2),n=t[0],a=t[1],o=e.alt,i=e.recorded_at;return r.a.createElement("tbody",null,r.a.createElement("tr",null,r.a.createElement("td",null,"Coordinates"),r.a.createElement("td",{className:"capitalize"},n," ",a)),o?r.a.createElement("tr",null,r.a.createElement("td",null,"Altitude"),r.a.createElement("td",{className:"capitalize"},o)):null,i?r.a.createElement("tr",null,r.a.createElement("td",null,"Recorded at"),r.a.createElement("td",{className:"capitalize"},V(new Date(i)))):null)}},ee={locationMarker:function(){return"location"},deviceStatusMarker:function(e){return e.deviceStatus}},te=function(e){var t=e.type,n=Object(I.a)(e,["type"]);return r.a.createElement("table",{className:"device-status-table"},r.a.createElement("thead",null,r.a.createElement("tr",null,r.a.createElement("th",{colSpan:2,className:"capitalize"},ee[t](n)))),$[t](n))},ne=(n(106),n(107),n(108),"map-container"),ae=function(e){return r.a.createElement(te,e)},re=new URLSearchParams(window.location.search),oe=re.get("gist"),ie=re.get("locations"),ce="true"===re.get("shed_animation"),se=re.get("accessToken"),ue=!re.get("hash")||"false"!==re.get("hash"),le=JSON.parse(ie);var me=function(){var e=r.a.useState(!0),t=Object(c.a)(e,2),n=t[0],a=t[1],o=r.a.useState(void 0),i=Object(c.a)(o,2),s=i[0],u=i[1],l=r.a.useState(void 0),m=Object(c.a)(l,2),d=m[0],p=m[1],f=r.a.useReducer(X.baseReducer,{jsons:[],currentJson:0}),y=Object(c.a)(f,2),g=y[0],v=y[1],b=g||{},h=b.jsons,E=b.currentJson,O=C.useAccessToken(se,p),S={linear:ce},N=C.useMap(ne,{accessToken:O,hash:ue,fitBoundsOptions:S}),j=r.a.useRef([]),_=C.usePopup(N),k=C.usePopup(N,{offset:10});r.a.useEffect((function(){if(O)if(oe){var e=oe.split("/").pop();fetch("https://api.github.com/gists/".concat(e)).then((function(e){return e.json()})).then((function(e){if(e.message)console.error(e.message),p(e.message);else{var t=JSON.parse(e.files["default.json"]?e.files["default.json"].content:Object.values(e.files)[0].content);u(t)}})).catch((function(e){console.error(e),p(e)}))}else if(le&&le.length){var t=new x.Line({coordinates:le,type:"LineString"});N.current.on("load",(function(){return w({json:t,fromLocalStorage:!0,showModal:!1})}))}else{var n=localStorage.getItem("previousJSON"),a=JSON.parse(n);a&&N.current.on("load",(function(){return w({json:a,fromLocalStorage:!0})}))}}),[O]),r.a.useEffect((function(){h&&u(h[E])}),[E]),r.a.useEffect((function(){var e={0:"_zero_",1:"_one_"};h.forEach((function(t,n){if("LineString"===t.type){var a=new x.Line(t);L.plotLine({mapRef:N,popupRef:_,line:a,getStatusTable:ae,fitBoundsOptions:S,index:e[n]})}else try{var r=t.summary,o=r.locations,i=r.markers,c=new x.Line(o),s=X.markersByType(i)("device_status");L.plotLine({mapRef:N,popupRef:_,line:c,getStatusTable:ae,fitBoundsOptions:S,index:e[n]}),L.useMarkers({mapRef:N,popupRef:k,markersRef:j,deviceStatusMarkers:s,getStatusTable:ae,index:e[n]})}catch(d){console.error(d),p(d)}}))}),[h.length]);var w=function(e){var t=e.json,n=e.fromLocalstorage,r=e.showModal,o=e.noPageChange;u(t),v({type:X.reducerActions.addNewJson,json:t,noPageChange:o}),n||localStorage.setItem("previousJSON",JSON.stringify(t,null,"\t")),a(!r)};return r.a.createElement("div",{className:"app-container"},O&&r.a.createElement("div",{id:ne}),r.a.createElement(q,{fetchError:d,trip:s,showTripModal:n,showModal:function(){return a(!0)},hideModal:function(){return a(!1)},updateJson:w,currentJsonIndex:E,goToPageZero:function(){return v({type:X.reducerActions.changeJsonIndex,index:0})}}))};i.a.render(r.a.createElement(me,null),document.getElementById("root"))},39:function(e,t,n){},52:function(e,t,n){e.exports=n(109)},57:function(e,t,n){},59:function(e,t,n){},60:function(e){e.exports=JSON.parse('{"properties":{"trip_id":{"type":"string","format":"uuid"},"device_id":{"type":"string","format":"uuid"},"started_at":{"type":"string","format":"date-time"},"completed_at":{"type":"string","format":"date-time"},"status":{"type":"string"},"views":{"properties":{"embed_url":{"type":"string","format":"uri"},"share_url":{"type":"string","format":"uri"}}},"analytics":{"properties":{"total_duration":{"type":"number"},"active_count":{"type":"number"},"active_duration":{"type":"number"},"stop_count":{"type":"number"},"stop_duration":{"type":"number"},"active_distance":{"type":"number"},"walk_count":{"type":"number"},"walk_duration":{"type":"number"},"walk_distance":{"type":"number"},"drive_count":{"type":"number"},"drive_duration":{"type":"number"},"drive_distance":{"type":"number"},"inactive_count":{"type":"number"},"inactive_duration":{"type":"number"}}},"summary":{"properties":{"distance":{"type":"number"},"duration":{"type":"number"},"started_at":{"type":"string","format":"date-time"},"completed_at":{"type":"string","format":"date-time"},"device_id":{"type":"string","format":"uuid"},"locations":{"properties":{"type":{"type":"string"},"coordinates":{"type":"array","items":{"type":"array","maxItems":4,"minItems":2,"items":[{"type":"number","minimum":-179.999999,"maximum":179.999999},{"type":"number","minimum":-89.999999,"maximum":89.999999},{"type":["number","null"],"minimum":-12262,"maximum":11000},{"type":"string","format":"date-time"}]}}}},"markers":{"type":"array","items":[{"properties":{"type":{"type":"string"},"data":{"properties":{"activity":{"type":"string"},"duration":{"type":"number"},"value":{"type":"string"},"start":{"properties":{"recorded_at":{"type":"string","format":"date-time"},"location":{"properties":{"recorded_at":{"type":"string","format":"date-time"},"geometry":{"properties":{"type":{"type":"string"},"coordinates":{"type":"array","maxItems":4,"minItems":2,"items":[{"type":"number","minimum":-179.999999,"maximum":179.999999},{"type":"number","minimum":-89.999999,"maximum":89.999999},{"type":["number","null"],"minimum":-12262,"maximum":11000},{"type":"string","format":"date-time"}]}}}}}}},"end":{"properties":{"recorded_at":{"type":"string","format":"date-time"},"location":{"properties":{"recorded_at":{"type":"string","format":"date-time"},"geometry":{"properties":{"type":{"type":"string"},"coordinates":{"type":"array","maxItems":4,"minItems":2,"items":[{"type":"number","minimum":-179.999999,"maximum":179.999999},{"type":"number","minimum":-89.999999,"maximum":89.999999},{"type":["number","null"],"minimum":-12262,"maximum":11000},{"type":"string","format":"date-time"}]}}}}}}}}}}}]}}}}}')},61:function(e){e.exports=JSON.parse('{"properties":{"type":{"type":"string"},"coordinates":{"type":"array","items":{"type":"array","maxItems":4,"minItems":2,"items":[{"type":"number","minimum":-179.999999,"maximum":179.999999},{"type":"number","minimum":-89.999999,"maximum":89.999999},{"type":["number","null"],"minimum":-12262,"maximum":11000},{"type":"string","format":"date-time"}]}}}}')}},[[52,1,2]]]);
//# sourceMappingURL=main.90592bbe.chunk.js.map