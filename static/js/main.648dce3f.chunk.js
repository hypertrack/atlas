(this.webpackJsonpperseus=this.webpackJsonpperseus||[]).push([[0],{149:function(e,t,n){e.exports=n(221)},154:function(e,t,n){},156:function(e,t,n){},157:function(e){e.exports=JSON.parse('{"properties":{"trip_id":{"type":"string","format":"uuid"},"device_id":{"type":"string","format":"uuid"},"started_at":{"type":"string","format":"date-time"},"completed_at":{"type":"string","format":"date-time"},"status":{"type":"string"},"views":{"properties":{"embed_url":{"type":"string","format":"uri"},"share_url":{"type":"string","format":"uri"}}},"analytics":{"properties":{"total_duration":{"type":"number"},"active_count":{"type":"number"},"active_duration":{"type":"number"},"stop_count":{"type":"number"},"stop_duration":{"type":"number"},"active_distance":{"type":"number"},"walk_count":{"type":"number"},"walk_duration":{"type":"number"},"walk_distance":{"type":"number"},"drive_count":{"type":"number"},"drive_duration":{"type":"number"},"drive_distance":{"type":"number"},"inactive_count":{"type":"number"},"inactive_duration":{"type":"number"}}},"summary":{"properties":{"distance":{"type":"number"},"duration":{"type":"number"},"started_at":{"type":"string","format":"date-time"},"completed_at":{"type":"string","format":"date-time"},"device_id":{"type":"string","format":"uuid"},"locations":{"properties":{"type":{"type":"string"},"coordinates":{"type":"array","items":{"type":"array","maxItems":4,"minItems":2,"items":[{"type":"number","minimum":-179.999999,"maximum":179.999999},{"type":"number","minimum":-89.999999,"maximum":89.999999},{"type":["number","null"],"minimum":-12262,"maximum":11000},{"type":"string","format":"date-time"}]}}}},"markers":{"type":"array","items":[{"properties":{"type":{"type":"string"},"data":{"properties":{"activity":{"type":"string"},"duration":{"type":"number"},"value":{"type":"string"},"start":{"properties":{"recorded_at":{"type":"string","format":"date-time"},"location":{"properties":{"recorded_at":{"type":"string","format":"date-time"},"geometry":{"properties":{"type":{"type":"string"},"coordinates":{"type":"array","maxItems":4,"minItems":2,"items":[{"type":"number","minimum":-179.999999,"maximum":179.999999},{"type":"number","minimum":-89.999999,"maximum":89.999999},{"type":["number","null"],"minimum":-12262,"maximum":11000},{"type":"string","format":"date-time"}]}}}}}}},"end":{"properties":{"recorded_at":{"type":"string","format":"date-time"},"location":{"properties":{"recorded_at":{"type":"string","format":"date-time"},"geometry":{"properties":{"type":{"type":"string"},"coordinates":{"type":"array","maxItems":4,"minItems":2,"items":[{"type":"number","minimum":-179.999999,"maximum":179.999999},{"type":"number","minimum":-89.999999,"maximum":89.999999},{"type":["number","null"],"minimum":-12262,"maximum":11000},{"type":"string","format":"date-time"}]}}}}}}}}}}}]}}}}}')},158:function(e){e.exports=JSON.parse('{"properties":{"type":{"type":"string"},"coordinates":{"type":"array","items":{"type":"array","maxItems":4,"minItems":2,"items":[{"type":"number","minimum":-179.999999,"maximum":179.999999},{"type":"number","minimum":-89.999999,"maximum":89.999999},{"type":["number","null"],"minimum":-12262,"maximum":11000},{"type":"string","format":"date-time"}]}}}}')},220:function(e,t,n){},221:function(e,t,n){"use strict";n.r(t);var a=n(0),r=n.n(a),o=n(11),i=n.n(o),c=(n(154),n(12)),s=n(13),u=n(44),l=n(15),m=n(18),d=n.n(m),p=n(51),f=n.n(p);n(156);function y(){var e=Object(u.a)(["deviceStatusMarkers"]);return y=function(){return e},e}function g(){var e=Object(u.a)(["locationMarkers"]);return g=function(){return e},e}function v(){var e=Object(u.a)(["route"]);return v=function(){return e},e}var b,h=function(e,t){var n=t;if(e.current.getLayer(t)||e.current.getLayer("".concat(t,"1"))){n=e.current.getLayer(t)?"".concat(t,"1"):t;var a=e.current.getLayer(t)?t:"".concat(t,"1");e.current.removeLayer(a),e.current.removeSource(a)}return n},E=function(e,t,n){t.current.getCanvas().style.cursor="pointer";for(var a=e.features[0].geometry.coordinates.slice(),r=e.features[0].properties.description;Math.abs(e.lngLat.lng-a[0])>180;)a[0]+=e.lngLat.lng>a[0]?360:-360;n.current.setLngLat(a).setHTML(r).addTo(t.current)},O=function(e,t){e.current.getCanvas().style.cursor="",t.current.remove()},S=function(e){return function(t){return t+e}},j={_zero_:"#6397FF",_one_:"#FF8D69"},N=function(e){var t=e.mapRef,n=e.popupRef,a=e.line,r=e.getStatusTable,o=e.fitBoundsOptions,i=e.index,s=h(t,S(i)(v()));t.current.addLayer({id:s,type:"line",source:{type:"geojson",data:{type:"Feature",properties:{},geometry:a}},layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":j[i],"line-width":8}}).fitBounds(function(e){var t=new d.a.LngLat(e[0][0],e[0][1]),n=new d.a.LngLatBounds(t,t);return e.reduce((function(e,t){var n=Object(c.a)(t,2),a=n[0],r=n[1];return e.extend(new d.a.LngLat(a,r))}),n)}(a.coordinates),Object(l.a)(Object(l.a)({},o),{},{padding:{top:40,bottom:40,left:20,right:20}})),s=h(t,S(i)(g())),t.current.addLayer({id:s,type:"symbol",source:{type:"geojson",data:{type:"FeatureCollection",features:a.coordinates.map((function(e){var t=Object(c.a)(e,4),n=t[0],a=t[1],o=t[2],i=t[3];return{type:"Feature",properties:{description:f.a.renderToString(r({type:"locationMarker",coordinates:[a,n],alt:o,recorded_at:i})),icon:"marker"},geometry:new k.Point({type:"Point",coordinates:[n,a]})}}))}},layout:{"icon-image":"{icon}-15","icon-allow-overlap":!1}}),t.current.on("mouseenter",s,(function(e){return E(e,t,n)})),t.current.on("mouseleave",s,(function(){return O(t,n)}))},_=function(e){var t=e.mapRef,n=e.popupRef,a=e.markersRef,r=e.deviceStatusMarkers,o=e.getStatusTable,i=(e.fitBoundsOptions,e.index),c=h(t,S(i)(y())),s=r.map((function(e){var a=e.start,r=e.end,i=e.deviceStatus,c=e.activity;if(a||r){var s=Z.getIcon(c||i),u=document.createElement("div");u.className="marker-container",u.innerHTML="<img src=".concat(Z.getImageSource(s)," alt=").concat(s,' class="marker-image"/>'),u.addEventListener("mouseenter",(function(a){return function(e,t,n,a,r){var o=a.start,i=a.end;t.current.getCanvas().style.cursor="pointer";var c=(o&&o.location?o.location.coordinates:i&&i.location?i.location.coordinates:[]).slice(),s=f.a.renderToString(r(Object(l.a)({type:"deviceStatusMarker"},a)));n.current.setLngLat(c).setHTML(s).addTo(t.current)}(0,t,n,e,o)})),u.addEventListener("mouseleave",(function(){return O(t,n)}));var m=a&&a.location?a.location.coordinates:r&&r.location?r.location.coordinates:[];return new d.a.Marker(u).setLngLat(m).addTo(t.current)}return null})).filter(Boolean);t.current.on("mouseenter",c,(function(e){return E(e,t,n)})),t.current.on("mouseleave",c,(function(){return O(t,n)})),a.current=s},w=n(52),k={Line:function e(t){var n=t.type,a=t.coordinates;Object(w.a)(this,e),this.type=n,this.coordinates=a},Point:function e(t){var n=t.type,a=t.coordinates;Object(w.a)(this,e),this.type=n,this.coordinates=a}},J=n(30),T=function(e,t){var n=t.accessToken,a=Object(J.a)(t,["accessToken"]),o=r.a.useRef();return r.a.useEffect((function(){o&&o.current||!n||(o.current=new d.a.Map(Object(l.a)({container:e,style:"mapbox://styles/mapbox/streets-v9",keyboard:!0,center:[0,0],accessToken:n},a)))}),[e,n]),r.a.useEffect((function(){n&&(d.a.accessToken=n)}),[n]),o},L=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=r.a.useRef(new d.a.Popup(Object(l.a)({closeButton:!1,closeOnClick:!1},t)));return r.a.useEffect((function(){e.current&&e.current.on("load",(function(){n.current.addTo(e.current)}))}),[e,n]),n},x=function(e,t){var n=r.a.useState(e),a=Object(c.a)(n,2),o=a[0],i=a[1];return r.a.useEffect((function(){if(e)localStorage.setItem("accessToken",e);else{var t=localStorage.getItem("accessToken");t&&(d.a.accessToken=t,i(t))}}),[e]),r.a.useEffect((function(){o?t():t("Missing access token")}),[o]),o},M=n(24),I=n(94),C=n(157),R=n(158),P=new(n(159))({allErrors:!0}),B=P.compile(C),A=P.compile(R),D=function(e){var t=e.recorded_at,n=e.location,a={};return t&&(a.timestamp=t),n&&n.geometry&&(a.location=new k.Point(n.geometry)),a},F={geofence:function(e){var t=e.arrival,n=e.geofence,a=new k.Point(t.location.geometry),r=new k.Point(n.geometry);return{arrival:{arrivalPoint:a,arrivalTime:t.location.recorded_at},geofence:{geofencePoint:r,geofenceId:n.geofence_id,geofenceMetadata:JSON.stringify(n.metadata,null,2),radius:Number(n.radius)}}},device_status:function(e){var t=e.activity,n=e.duration,a=e.value,r=D(e.end),o=D(e.start),i={};return t&&(i.activity=t),n&&(i.duration=n),Object(l.a)({start:o,end:r,deviceStatus:a},i)}},z=function(e){var t=e.type,n=e.data;return F[t]?F[t](n):n},H=["disconnected","inactive","unknown","stop","walk","run","drive"],U={trip:B,LineString:A},G={updateJson:"UPDATE_JSON",addNewJson:"ADD_NEW_JSON",changeJsonIndex:"UPDATE_JSON_INDEX"},Y=(b={},Object(M.a)(b,G.updateJson,(function(e,t){var n=Object(l.a)({},e),a=t.index,r=t.json;return n.jsons[a]=r,n})),Object(M.a)(b,G.addNewJson,(function(e,t){var n=Object(l.a)({},e),a=t.json,r=t.noPageChange;n.jsons[e.currentJson]=a;var o=r?e.currentJson:1;return n.currentJson=o,n})),Object(M.a)(b,G.changeJsonIndex,(function(e,t){var n=t.index,a=Object(l.a)({},e);return a.currentJson=n,a})),b),Z={parseMarker:z,getIcon:function(e,t){return H.includes(t)?t:H.includes(e)?e:"unknown"},secondsToHms:function(e){e=Number(e);var t=Math.floor(e/3600),n=Math.floor(e%3600/60),a=Math.floor(e%3600%60);return(t>0?t+" h ":"")+(n>0?n+" m ":"")+(a>0?a+" s":"")},markersByType:function(e){return function(t){var n=e.reduce((function(e,t){return Object(l.a)(Object(l.a)({},e),{},Object(M.a)({},t.type,e[t.type]?[z(t)].concat(Object(I.a)(e[t.type])):[z(t)]))}),{});return t&&n[t]?n[t]:n}},validateInputJSON:function(e){var t=U[e.type||"trip"];return!(!t||t(e))&&t.errors},valid_device_status_states:H,getImageSource:function(e){return"".concat("/perseus","/assets/").concat(e,".png")},baseReducer:function(e,t){var n=t.type,a=Object(J.a)(t,["type"]);return Y[n]?Y[n](e,a):e},reducerActions:G},K=(n(64),function(e){var t=e.trip,n=e.showTripModal,a=e.updateJson,o=e.hideModal,i=e.showModal,u=e.fetchError,l=e.currentJsonIndex,m=e.goToPageZero,d=r.a.useState(JSON.stringify(t,null,"\t")),p=Object(c.a)(d,2),f=p[0],y=p[1],g=r.a.useState(void 0),v=Object(c.a)(g,2),b=v[0],h=v[1],E=r.a.useState(void 0),O=Object(c.a)(E,2),S=O[0],j=O[1],N=u||S;r.a.useEffect((function(){JSON.stringify(t)!==JSON.stringify(f)&&y(JSON.stringify(t,null,"\t"))}),[t]),r.a.useEffect((function(){u&&u!==N&&j(u)}),[u]);var _,w=function(e){var t=Z.validateInputJSON(e);return t&&t.length?j(t):j(null),Boolean(t)},k=function(e){try{var t=JSON.parse(f);a(e?{json:t,showModal:!l}:{json:t,showModal:!0,noPageChange:!0})}catch(n){console.error(n),j(n)}};return r.a.createElement(r.a.Fragment,null,r.a.createElement(s.Button,{intent:s.Intent.SUCCESS,className:"show-trip-button",onClick:function(){return n?o():i()}},"Update JSON"),r.a.createElement(s.Dialog,{isOpen:N||n,title:(_=Boolean(t),_?"Modify data":"Add your own JSON"),onClose:o,className:"dialog",isCloseButtonShown:!1,canEscapeKeyClose:!1,canOutsideClickClose:!1},r.a.createElement("div",{className:s.Classes.DIALOG_BODY},r.a.createElement("div",{className:"dialog-container"},r.a.createElement(s.TextArea,{value:f||"",disabled:!1,onChange:function(e){return y(e.target.value)},className:"user-summary-input",placeholder:"Paste trip_summary here",onBlur:function(e){e&&e.preventDefault();var t=e.target.value;if(t)try{var n=JSON.parse(t);w(n)}catch(a){console.error(a),j(a)}}}),N?r.a.createElement("div",{className:"error-table-container"},Array.isArray(N)?r.a.createElement(s.HTMLTable,{className:"error-table",bordered:!0},r.a.createElement("caption",null,"There ",N.length>1?"are":"is an"," ",N.length>1?N.length:""," issue",N.length>1?"s":""),r.a.createElement("thead",null,r.a.createElement("tr",null,r.a.createElement("th",null,"Location"),r.a.createElement("th",null,"Issue"))),r.a.createElement("tbody",null,N.map((function(e){return r.a.createElement("tr",{key:e.dataPath},r.a.createElement("td",null,r.a.createElement("div",{className:"table-content"},e.dataPath)),r.a.createElement("td",null,r.a.createElement("div",{className:"table-content"},e.message)))})))):r.a.createElement("div",{className:"error-table error"},N.message?N.message:JSON.stringify(N))):null)),r.a.createElement("div",{className:s.Classes.DIALOG_FOOTER},r.a.createElement("div",{className:s.Classes.DIALOG_FOOTER_ACTIONS},r.a.createElement(s.FileInput,{text:b,buttonText:"Browse",className:"file-input",onInputChange:function(e){e&&e.preventDefault();var t=new FileReader,n=e.target.files[0];h(n&&n.name?n.name:void 0),t.readAsText(n,"UTF-8"),t.onload=function(e){var t=e.target.result,n=JSON.parse(t);y(t),w(n)||(a({json:n,showModal:!0,noPageChange:!0}),o())}},inputProps:{accept:".json"}}),l?r.a.createElement(s.Button,{icon:"caret-left",className:"add-new-json",disabled:N&&N.length,onClick:function(e){e&&e.preventDefault();try{var t=JSON.parse(f);t&&a(t,!1,!0),m()}catch(n){console.error(n),j(n)}}},"Check previous JSON"):r.a.createElement(s.Button,{icon:"plus",className:"add-new-json",disabled:N&&N.length||!f,onClick:function(){return k(!0)}},"Add another JSON"),r.a.createElement(s.Button,{onClick:function(e){y(JSON.stringify(t,null,"\t")),o()}},"Close"),r.a.createElement(s.Button,{intent:s.Intent.PRIMARY,disabled:N&&N.length||!f,onClick:function(){return k()}},"Update")))))}),W=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"],X=function(e){return W[e.getMonth()]+" "+e.getDate()+", "+e.getFullYear()+" "+e.getHours()+":"+e.getMinutes()+":"+e.getSeconds()},q={deviceStatusMarker:function(e){var t=e.start,n=e.end,a=(e.deviceStatus,e.activity),o=e.duration;return r.a.createElement("tbody",null,t?r.a.createElement("tr",{className:"capitalize"},r.a.createElement("td",null,"Start Time"),r.a.createElement("td",null,X(new Date(t.timestamp)))):null,n?r.a.createElement("tr",{className:"capitalize"},r.a.createElement("td",null,"End Time"),r.a.createElement("td",null,X(new Date(n.timestamp)))):null,o?r.a.createElement("tr",null,r.a.createElement("td",null,"Duration"),r.a.createElement("td",null,Z.secondsToHms(o))):null,a?r.a.createElement("tr",null,r.a.createElement("td",null,"Activity"),r.a.createElement("td",{className:"capitalize"},a)):null)},locationMarker:function(e){var t=Object(c.a)(e.coordinates,2),n=t[0],a=t[1],o=e.alt,i=e.recorded_at;return r.a.createElement("tbody",null,r.a.createElement("tr",null,r.a.createElement("td",null,"Coordinates"),r.a.createElement("td",{className:"capitalize"},n," ",a)),o?r.a.createElement("tr",null,r.a.createElement("td",null,"Altitude"),r.a.createElement("td",{className:"capitalize"},o)):null,i?r.a.createElement("tr",null,r.a.createElement("td",null,"Recorded at"),r.a.createElement("td",{className:"capitalize"},X(new Date(i)))):null)}},Q={locationMarker:function(){return"location"},deviceStatusMarker:function(e){return e.deviceStatus}},V=function(e){var t=e.type,n=Object(J.a)(e,["type"]);return r.a.createElement("table",{className:"device-status-table"},r.a.createElement("thead",null,r.a.createElement("tr",null,r.a.createElement("th",{colSpan:2,className:"capitalize"},Q[t](n)))),q[t](n))},$=(n(218),n(219),n(220),function(e){return r.a.createElement(V,e)}),ee=new URLSearchParams(window.location.search),te=ee.get("gist"),ne=ee.get("locations"),ae="true"===ee.get("shed_animation"),re=ee.get("accessToken"),oe=!ee.get("hash")||"false"!==ee.get("hash"),ie=JSON.parse(ne);var ce=function(){var e=r.a.useState(!1),t=Object(c.a)(e,2),n=t[0],a=t[1],o=r.a.useState(void 0),i=Object(c.a)(o,2),s=i[0],u=i[1],l=r.a.useState(void 0),m=Object(c.a)(l,2),d=m[0],p=m[1],f=r.a.useReducer(Z.baseReducer,{jsons:[],currentJson:0}),y=Object(c.a)(f,2),g=y[0],v=y[1],b=g||{},h=b.jsons,E=b.currentJson,O=x(re,p),S={linear:ae},j=T("map-container",{accessToken:O,hash:oe,fitBoundsOptions:S}),w=r.a.useRef([]),J=L(j),M=L(j,{offset:10});r.a.useEffect((function(){if(O)if(te){var e=te.split("/").pop();fetch("https://api.github.com/gists/".concat(e)).then((function(e){return e.json()})).then((function(e){if(e.message)console.error(e.message),p(e.message);else{var t=JSON.parse(e.files["default.json"]?e.files["default.json"].content:Object.values(e.files)[0].content);u(t)}})).catch((function(e){console.error(e),p(e)}))}else if(ie&&ie.length){var t=new k.Line({coordinates:ie,type:"LineString"});j.current.on("load",(function(){return I({json:t,fromLocalStorage:!0,showModal:!1})}))}else{var n=localStorage.getItem("previousJSON"),a=JSON.parse(n);a&&j.current.on("load",(function(){return I({json:a,fromLocalStorage:!0})}))}}),[O]),r.a.useEffect((function(){h&&u(h[E])}),[E]),r.a.useEffect((function(){var e={0:"_zero_",1:"_one_"};h.forEach((function(t,n){if("LineString"===t.type){var a=new k.Line(t);N({mapRef:j,popupRef:J,line:a,getStatusTable:$,fitBoundsOptions:S,index:e[n]})}else try{var r=t.summary,o=r.locations,i=r.markers,c=new k.Line(o),s=Z.markersByType(i)("device_status");N({mapRef:j,popupRef:J,line:c,getStatusTable:$,fitBoundsOptions:S,index:e[n]}),_({mapRef:j,popupRef:M,markersRef:w,deviceStatusMarkers:s,getStatusTable:$,index:e[n]})}catch(d){console.error(d),p(d)}}))}),[h.length]);var I=function(e){var t=e.json,n=e.fromLocalstorage,r=(e.showModal,e.noPageChange);u(t),v({type:Z.reducerActions.addNewJson,json:t,noPageChange:r}),n||localStorage.setItem("previousJSON",JSON.stringify(t,null,"\t")),a(!1)};return r.a.createElement("div",{className:"app-container"},O&&r.a.createElement("div",{id:"map-container"}),r.a.createElement(K,{fetchError:d,trip:s,showTripModal:n,showModal:function(){return a(!0)},hideModal:function(){return a(!1)},updateJson:I,currentJsonIndex:E,goToPageZero:function(){return v({type:Z.reducerActions.changeJsonIndex,index:0})}}))};i.a.render(r.a.createElement(ce,null),document.getElementById("root"))},64:function(e,t,n){}},[[149,1,2]]]);
//# sourceMappingURL=main.648dce3f.chunk.js.map